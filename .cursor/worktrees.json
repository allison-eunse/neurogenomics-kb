{
  "setup-worktree-unix": [
    "echo \"[worktree-setup] Starting (Unix) in $(pwd)\"",
    "echo \"[worktree-setup] ROOT_WORKTREE_PATH=${ROOT_WORKTREE_PATH:-<unset>}\"",
    "if [ \"$(uname)\" = \"Darwin\" ]; then echo \"[worktree-setup] macOS detected - checking Homebrew\"; if command -v brew >/dev/null 2>&1; then echo \"[worktree-setup] Homebrew found: $(brew --version | head -n1)\"; eval \"$(brew shellenv)\" 2>/dev/null || true; else echo \"[worktree-setup] Homebrew not found. Install from https://brew.sh if needed\"; fi; fi",
    "if [ \"$(uname)\" = \"Darwin\" ] && command -v brew >/dev/null 2>&1; then echo \"[worktree-setup] Checking system dependencies via Homebrew\"; BREW_PACKAGES=\"\"; if ! command -v python3 >/dev/null 2>&1; then BREW_PACKAGES=\"$BREW_PACKAGES python@3.11\"; fi; if ! command -v git >/dev/null 2>&1; then BREW_PACKAGES=\"$BREW_PACKAGES git\"; fi; if ! command -v git-lfs >/dev/null 2>&1; then BREW_PACKAGES=\"$BREW_PACKAGES git-lfs\"; fi; if [ -n \"$BREW_PACKAGES\" ]; then echo \"[worktree-setup] Installing missing packages:$BREW_PACKAGES\"; brew install $BREW_PACKAGES || echo \"[worktree-setup] Homebrew install failed (non-blocking)\"; else echo \"[worktree-setup] All essential system packages present\"; fi; fi",
    "if [ \"$(uname)\" = \"Darwin\" ] && command -v brew >/dev/null 2>&1 && ! command -v uv >/dev/null 2>&1; then echo \"[worktree-setup] Installing uv for faster Python package management\"; brew install uv || echo \"[worktree-setup] uv install failed (non-blocking)\"; fi",
    "if [ \"$(uname)\" = \"Linux\" ]; then echo \"[worktree-setup] Linux detected - checking package manager\"; if command -v apt-get >/dev/null 2>&1; then PKG_MGR=\"apt-get\"; elif command -v yum >/dev/null 2>&1; then PKG_MGR=\"yum\"; elif command -v dnf >/dev/null 2>&1; then PKG_MGR=\"dnf\"; else PKG_MGR=\"\"; fi; if [ -n \"$PKG_MGR\" ]; then echo \"[worktree-setup] Found package manager: $PKG_MGR\"; MISSING=\"\"; if ! command -v python3 >/dev/null 2>&1; then MISSING=\"$MISSING python3 python3-pip python3-venv\"; fi; if ! command -v git >/dev/null 2>&1; then MISSING=\"$MISSING git\"; fi; if [ -n \"$MISSING\" ]; then echo \"[worktree-setup] WARNING: Missing packages:$MISSING - run 'sudo $PKG_MGR install$MISSING' to install\"; fi; else echo \"[worktree-setup] No supported package manager found\"; fi; fi",
    "echo \"[worktree-setup] Node: $(command -v node || echo 'missing')\"",
    "echo \"[worktree-setup] Python: $(command -v python3 || echo 'missing')\"",
    "echo \"[worktree-setup] Git: $(command -v git || echo 'missing')\"",
    "if command -v uv >/dev/null 2>&1; then echo \"[worktree-setup] Using uv for Python deps (fast)\"; uv venv .venv || true; . .venv/bin/activate; if [ -f requirements.txt ]; then uv pip install -r requirements.txt; fi; else PY_BIN=${PY_BIN:-python3}; if command -v \"$PY_BIN\" >/dev/null 2>&1; then if [ ! -d .venv ]; then \"$PY_BIN\" -m venv .venv; fi; . .venv/bin/activate; python -m pip install --upgrade pip setuptools wheel; if [ -f requirements.txt ]; then pip install -r requirements.txt; fi; else echo \"[worktree-setup] WARNING: python3 not found; skipping Python setup\"; fi; fi",
    "if [ -f package.json ]; then if command -v pnpm >/dev/null 2>&1; then echo \"[worktree-setup] Installing Node deps with pnpm\"; pnpm install --frozen-lockfile || pnpm install; pnpm run build || true; elif command -v bun >/dev/null 2>&1; then echo \"[worktree-setup] Installing Node deps with bun\"; bun install; bun run build || true; elif command -v npm >/dev/null 2>&1; then echo \"[worktree-setup] Installing Node deps with npm\"; npm ci || npm install; npm run build || true; else echo \"[worktree-setup] WARNING: No Node package manager found\"; fi; fi",
    "if [ -f .env.example ] && [ ! -f .env ]; then cp .env.example .env && echo \"[worktree-setup] Created .env from .env.example\"; fi",
    "if [ -n \"${ROOT_WORKTREE_PATH:-}\" ] && [ -f \"$ROOT_WORKTREE_PATH/.env.example\" ] && [ ! -f .env ]; then cp \"$ROOT_WORKTREE_PATH/.env.example\" .env && echo \"[worktree-setup] Seeded .env from ROOT_WORKTREE_PATH/.env.example\"; fi",
    "if [ -f .gitmodules ]; then echo \"[worktree-setup] Initializing git submodules\"; git submodule update --init --recursive || echo \"[worktree-setup] Submodule update failed (non-blocking)\"; fi",
    "if ! command -v pre-commit >/dev/null 2>&1 && [ -d .venv ]; then echo \"[worktree-setup] Installing pre-commit via pip\"; . .venv/bin/activate && pip install pre-commit || echo \"[worktree-setup] pre-commit install failed (non-blocking)\"; fi",
    "if command -v pre-commit >/dev/null 2>&1; then echo \"[worktree-setup] Installing pre-commit hooks\"; pre-commit install --install-hooks || echo \"[worktree-setup] Pre-commit install failed (non-blocking)\"; fi",
    "if command -v mkdocs >/dev/null 2>&1; then echo \"[worktree-setup] Building mkdocs site (best-effort)\"; mkdocs build --strict || echo \"[worktree-setup] mkdocs build failed (non-blocking)\"; fi",
    "mkdir -p rag/vectordb kb/papers_fulltext || true",
    "if [ -f scripts/manage_kb.py ] && [ -d .venv ]; then echo \"[worktree-setup] Running KB validation (best-effort)\"; . .venv/bin/activate && python scripts/manage_kb.py validate models && python scripts/manage_kb.py validate datasets && python scripts/manage_kb.py validate links || echo \"[worktree-setup] KB validation failed (non-blocking)\"; fi",
    "echo \"[worktree-setup] Done (Unix).\""
  ],
  "setup-worktree-windows": [
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"Write-Host '[worktree-setup] Starting (Windows) in' (Get-Location)\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (Get-Command choco -ErrorAction SilentlyContinue) { Write-Host '[worktree-setup] Chocolatey found'; $missing = @(); if (!(Get-Command python -ErrorAction SilentlyContinue) -and !(Get-Command python3 -ErrorAction SilentlyContinue)) { $missing += 'python' }; if (!(Get-Command git -ErrorAction SilentlyContinue)) { $missing += 'git' }; if ($missing.Count -gt 0) { Write-Host '[worktree-setup] Installing missing packages via Chocolatey:' ($missing -join ', '); choco install $missing -y | Out-Null } } elseif (Get-Command winget -ErrorAction SilentlyContinue) { Write-Host '[worktree-setup] Winget found'; if (!(Get-Command python -ErrorAction SilentlyContinue) -and !(Get-Command python3 -ErrorAction SilentlyContinue)) { winget install Python.Python.3.11 --silent | Out-Null }; if (!(Get-Command git -ErrorAction SilentlyContinue)) { winget install Git.Git --silent | Out-Null } } else { Write-Host '[worktree-setup] No package manager found (choco/winget)' }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"$py = (Get-Command python -ErrorAction SilentlyContinue) ?? (Get-Command python3 -ErrorAction SilentlyContinue); if ($py) { Write-Host '[worktree-setup] Python found:' $py.Source; if (!(Test-Path '.\\.venv')) { & $py.Source -m venv .venv }; . .\\.venv\\Scripts\\Activate.ps1; python -m pip install --upgrade pip setuptools wheel; if (Test-Path '.\\requirements.txt') { pip install -r requirements.txt } } else { Write-Warning '[worktree-setup] python/python3 not found; skipping Python setup' }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (Test-Path '.\\package.json') { if (Get-Command pnpm -ErrorAction SilentlyContinue) { pnpm install --frozen-lockfile; if ($LASTEXITCODE -ne 0) { pnpm install }; pnpm run build | Out-Null } elseif (Get-Command bun -ErrorAction SilentlyContinue) { bun install; bun run build | Out-Null } elseif (Get-Command npm -ErrorAction SilentlyContinue) { npm ci; if ($LASTEXITCODE -ne 0) { npm install }; npm run build | Out-Null } else { Write-Warning '[worktree-setup] No Node package manager found' } }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if ((Test-Path '.\\.env') -eq $false -and (Test-Path '.\\.env.example')) { Copy-Item '.\\.env.example' '.\\.env'; Write-Host '[worktree-setup] Created .env from .env.example' }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if ($env:ROOT_WORKTREE_PATH -and (Test-Path \"$env:ROOT_WORKTREE_PATH\\.env.example\") -and (Test-Path '.\\.env') -eq $false) { Copy-Item \"$env:ROOT_WORKTREE_PATH\\.env.example\" '.\\.env'; Write-Host '[worktree-setup] Seeded .env from ROOT_WORKTREE_PATH\\.env.example' }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (Test-Path '.\\.gitmodules') { git submodule update --init --recursive }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (!(Get-Command pre-commit -ErrorAction SilentlyContinue) -and (Test-Path '.\\.venv')) { Write-Host '[worktree-setup] Installing pre-commit via pip'; . .\\.venv\\Scripts\\Activate.ps1; pip install pre-commit | Out-Null }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (Get-Command pre-commit -ErrorAction SilentlyContinue) { pre-commit install --install-hooks }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (Get-Command mkdocs -ErrorAction SilentlyContinue) { Write-Host '[worktree-setup] mkdocs build --strict (best-effort)'; mkdocs build --strict }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"New-Item -ItemType Directory -Force -Path '.\\rag\\vectordb' | Out-Null; New-Item -ItemType Directory -Force -Path '.\\kb\\papers_fulltext' | Out-Null\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"if (Test-Path '.\\scripts\\manage_kb.py' -and (Test-Path '.\\.venv')) { . .\\.venv\\Scripts\\Activate.ps1; python .\\scripts\\manage_kb.py validate models; python .\\scripts\\manage_kb.py validate datasets; python .\\scripts\\manage_kb.py validate links }\"",
    "powershell -NoProfile -ExecutionPolicy Bypass -Command \"Write-Host '[worktree-setup] Done (Windows).'\""
  ],
  "setup-worktree": [
    "echo \"Using generic fallback. Define OS-specific keys for best results (setup-worktree-unix / setup-worktree-windows).\""
  ]
}
